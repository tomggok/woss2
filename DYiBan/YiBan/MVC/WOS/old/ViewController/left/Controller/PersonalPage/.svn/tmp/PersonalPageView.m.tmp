

//
//  PersonalPageView.m
//  Yiban
//
//  Created by Hyde.Xu on 13-3-4.
//
//

#import "PersonalPageView.h"
#import "MessageDynamicViewController.h"
#import "UIImageView+WebCache.h"
#import "YiBanLocalDataManager.h"
#import "user.h"

#import "Rrequest_Data.h"
#import "HttpHelp.h"
#import "Static.h"
#import "MainConrtrollerCell.h"
#import "JsonResponse.h"
#import "status_list.h"
#import "PersonalPageImgViewController.h"
#import "LLSplitViewController.h"
#import "PersonalPageComingViewController.h"
#import "PersonalPageMessageViewController.h"
#import "PersonalPageImgSeeViewController.h"
#import "PersonalPageBdImgViewController.h"
#import "YiBanHeadBarView.h"
#import "UserSettingMode.h"
#import "FriendsViewController.h"
#import "PersonalPageBgSelectViewController.h"
#import "contact.h"
#import "Msg_content_Controller.h"
#import "AppDelegate.h"
#import "CannotAccessViewController.h"
#import "RightViewController.h"

#import "analysisXiTongFace.h"

#import "Debug.h"

#define BGIMGY  -56

@implementation PersonalPageView
@synthesize isOtherPeople,userModel=_userModel,isPush,isPresent=_isPresent,userId=_userId,isRight,changePersonLabelString;
@synthesize delegate;

- (void)dealloc
{
    [[NSNotificationCenter defaultCenter] removeObserver:self];
    [numLabelArray release];
    [changePersonLabelString release];
//    dyViewController.delegate = nil;
//    [dyViewController release];
    [delegate release];
    delegate = nil;
    [super dealloc];
}

- (id)initWithFrame:(CGRect)frame Userid:(NSString *)userid bOtherPeople:(BOOL)bOtherPeople bPush:(BOOL)bPush bPresent:(BOOL)bPresent bRight:(BOOL)bRight;
{
    self = [super initWithFrame:frame];
    if (self) {
        // Initialization code
        isRight = NO;
        numLabelArray = [[NSMutableArray alloc] initWithCapacity:4];
        
        self.userId = userid;
        self.isOtherPeople = bOtherPeople;
        self.isPush = bPush;
        self.isPresent = bPresent;
        self.isRight = bRight;
        
        
        //如果当前传进来的用户和自己的用户id
        YBLogInfo(@"[[[YiBanLocalDataManager sharedInstance] currentUser] userid] === %@",[[[YiBanLocalDataManager sharedInstance] currentUser] userid]);
        if (!_userId || [[[[YiBanLocalDataManager sharedInstance] currentUser] userid] isEqualToString:_userId]) {
            isOtherPeople = NO;
            
        }
        
        if (isOtherPeople) {
            [self forGetUser:_userId];
        }
        
        //背景颜色
        [self setBackgroundColor:YIALLVIEWBGCOLOR];
        
        //headerview
        headerWindows = [[YiBanHeadBarView alloc] initWithFrame:CGRectMake(0, 0, 320, 44) titleLabel:@"我的主页"];
        [headerWindows normalHeadView];
        if (isPush) {
            [[headerWindows leftButton] addTarget:self action:@selector(back) forControlEvents:UIControlEventTouchUpInside];
        }else{
            [headerWindows.leftButton setImage:[UIImage imageNamed:@"btn_leftmenu_a.png"] forState:UIControlStateNormal];
            [headerWindows.leftButton setImage:[UIImage imageNamed:@"btn_leftmenu_b.png"] forState:UIControlStateHighlighted];
            [headerWindows.rightButton setHidden:NO];
            [headerWindows.rightButton setImage:[UIImage imageNamed:@"btn_msg_a.png"] forState:UIControlStateNormal];
            [headerWindows.rightButton setImage:[UIImage imageNamed:@"btn_msg_b.png"] forState:UIControlStateHighlighted];
            [headerWindows setTipView];
            
            [headerWindows setClickRight];
            [[headerWindows leftButton] addTarget:self action:@selector(hidenSignalView) forControlEvents:UIControlEventTouchUpInside];
            [[headerWindows rightButton] addTarget:self action:@selector(hidenSignalView) forControlEvents:UIControlEventTouchUpInside];
        }
        [headerWindows setHidden:YES];
        
        tableHeaderA = [self tableHeaderView];//个人主页的一些介绍,易友,访客等
        
        downImgScroll = [[UIScrollView alloc] initWithFrame:CGRectMake(0, 44, 320, self.frame.size.height-44)];
        [downImgScroll setBackgroundColor:[UIColor clearColor]];
        [downImgScroll setContentSize:CGSizeMake(320, self.frame.size.height-44+1)];
        [downImgScroll setDelegate:self];
        
        [downImgScroll addSubview:tableHeaderA];
        [self addSubview:downImgScroll];
        [downImgScroll release];
        
        //headerview
        header = [[YiBanHeadBarView alloc] initWithFrame:CGRectMake(0, 0, 320, 44) titleLabel:@"我的主页"];
        [header normalHeadView];
        [self addHeaderClick];
        [self addSubview:header];
        [self insertSubview:header aboveSubview:downImgScroll];
        [header release];
        
        //动态列表的view
        tableView = [[UIView alloc] initWithFrame:CGRectMake(0, downImgScroll.frame.origin.y+tableHeaderA.frame.size.height, 320, self.frame.size.height-215 + 56 )];
        [tableView setBackgroundColor:YIALLVIEWBGCOLOR];
        [self addSubview:tableView];
        [tableView release];
        
        
        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(reloadHeaderView) name:NOTIFICATIONRELOADPAGEHEADERVIEW object:nil];
        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(useImg:) name:NOTIFICATIONIMGOBJECTFORUSE object:nil];
        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(changeBg:) name:NOTIFICATIONCHANGEPAGEBG2 object:nil];
        
        if (!isOtherPeople) {
            [NSTimer scheduledTimerWithTimeInterval:.5f target:self selector:@selector(initViewDidLoad) userInfo:nil repeats:NO];
        }
    }
    return self;
}

- (user *)userModel{
    if (!_userModel) {
        self.userModel = [[YiBanLocalDataManager sharedInstance] currentUser];
    }
    return _userModel;
}

- (NSString *)userId{
    if (!_userId) {
        self.userId = _userModel.userid;
    }
    return _userId;
}

- (id)init:(NSString *)userID isOther:(BOOL)isOther
{
    self = [super init];
    if (self) {
        self.userId = userID;
        self.isOtherPeople = isOther;
    }
    return self;
}

//返回
- (void)back{
    [[CommonHelper shareInstance]playSound:5];
    
    if (_isPresent) {
        [delegate dodimiss];
    }else{
        [delegate doleft];
    }
    if (isRight) {
        [[LLSplitViewController getmainController]showRightView:YES];
    }
}

- (void)hidenSignalView{
    [signalView cancelView];
}
-(NSString*)anaysisString{

    analysisXiTongFace *analysis = [[analysisXiTongFace alloc]init];
    NSMutableArray * array = [[NSMutableArray alloc]init];
    if (_userModel.desc.length > 40) {
        _userModel.desc = [_userModel.desc substringFromIndex:40];
    }
    NSString * tt = [analysis getImageRange:_userModel.desc :array];
    [array release];
    [analysis release];
    return tt;
}
- (void)initViewDidLoad{
    
    dyViewController = [[MessageDynamicViewController alloc] initWithFrame:CGRectMake(0, 20, 320, 400)];
    
    [[dyViewController table_view] setFrame:CGRectMake(0, 0, 320, 400)];
    [[dyViewController table_view]  setBackgroundColor:[UIColor clearColor]];
//    [[dyViewController table_view].headerView setHidden:YES];
    //调用动态
    [dyViewController setIsHiddenHeader:YES];
    [dyViewController setCheckPageView:YES];
    [dyViewController setDelegate:self];
    [dyViewController setUserModel:_userModel];

    dyViewController.checkPageView=YES;
    [dyViewController viewDidLoad];
    [tableView addSubview:dyViewController];
     
    [dyViewController release];
    if (isOtherPeople)
    {//不是当前用户
        [header setTitleLabelString:_userModel.name];
        [[dyViewController table_view] setFrame:CGRectMake([dyViewController table_view].frame.origin.x, [dyViewController table_view].frame.origin.y, [dyViewController table_view].frame.size.width, [dyViewController table_view].frame.size.height-45)];
        
        UIImageView *footImgBg = [[UIImageView alloc] initWithFrame:CGRectMake(0, self.bounds.size.height-45, 320, 45)];
        [footImgBg setImage:[UIImage imageNamed:@"graybar_foot.png"]];
        [footImgBg setUserInteractionEnabled:YES];
        [self addSubview:footImgBg];
        [footImgBg release];
        
        //加关注
        addMe = [[UIButton alloc] initWithFrame:CGRectMake(15, 0, 60, 45)];
        [self reloadAddFriend];
        
        [footImgBg addSubview:addMe];
        [addMe release];
        
        //发私信
        UIButton *sendM = [[UIButton alloc] initWithFrame:CGRectMake(addMe.frame.origin.x+addMe.frame.size.width+55, 0, 60, 45)];
        [sendM setBackgroundImage:[UIImage imageNamed:@"btn_sendmsg_a_1.png"] forState:UIControlStateNormal];
        [sendM setTag:2];
        [sendM addTarget:self action:@selector(footBarAction:) forControlEvents:UIControlEventTouchUpInside];
        [sendM setBackgroundImage:[UIImage imageNamed:@"btn_sendmsg_b_1.png"] forState:UIControlStateHighlighted];
        [footImgBg addSubview:sendM];
        [sendM release];
        
        //提醒
        UIButton *noticeM = [[UIButton alloc] initWithFrame:CGRectMake(sendM.frame.origin.x+sendM.frame.size.width+55, 0, 60, 45)];
        [noticeM setBackgroundImage:[UIImage imageNamed:@"btn_pagefrash_ta_a.png"] forState:UIControlStateNormal];
        [noticeM setBackgroundImage:[UIImage imageNamed:@"btn_pagefrash_ta_b.png"] forState:UIControlStateHighlighted];
        [noticeM addTarget:self action:@selector(footBarAction:) forControlEvents:UIControlEventTouchUpInside];
        [noticeM setTag:3];
        [footImgBg addSubview:noticeM];
        [noticeM release];
        
    }else{//当前用户进入
        self.userModel = [[YiBanLocalDataManager sharedInstance] currentUser];
        
        
        [dyViewController setCheckPageView:YES];
        [dyViewController setUserModel:_userModel];
        [[dyViewController table_view] reloadData];
        //给headerview上付值
        for (int i = 0; i < [numLabelArray count]; i++) {
            UILabel *numLabel = [numLabelArray objectAtIndex:i];
            if (numLabel.tag == 1) {
                [numLabel setText:_userModel.friend_num];
            }else if (numLabel.tag == 2){
                [numLabel setText:_userModel.visit_num];
            }else if (numLabel.tag == 3){
                [numLabel setText:_userModel.album_num];
            }else if (numLabel.tag == 4){
                [numLabel setText:_userModel.info_rate];
            }
        }

        [personLabel setText:[self anaysisString]];
        [headPortrait setImageWithURL:[NSURL URLWithString:_userModel.pic_s] placeholderImage:[UIImage imageNamed:@"noface_64.png"]];//
        
    }
    
    [self addHeaderClick];
    //个性签名
    signalView = [[ChangeSignalView alloc] initWithFrame:CGRectMake(0, 0, 320, 400)];
    [signalView setHidden:YES];
    [signalView setUserInteractionEnabled:YES];
    [signalView setBackgroundColor:[UIColor clearColor]];
    [signalView setDelegate:self];
    [theApp.window addSubview:signalView];
    if (!isOtherPeople) {
        [signalView setIsAddWindow:YES];
        [signalView setHideView:headerWindows];
        
    }
//    [headerWindows release];
    [signalView release];
}

//初始化header上的事件
- (void)addHeaderClick{
    if (isPush) {
        [[header leftButton] addTarget:self action:@selector(back) forControlEvents:UIControlEventTouchUpInside];
    }else{
        [header.leftButton setImage:[UIImage imageNamed:@"btn_leftmenu_a.png"] forState:UIControlStateNormal];
        [header.leftButton setImage:[UIImage imageNamed:@"btn_leftmenu_b.png"] forState:UIControlStateHighlighted];
        [header.rightButton setHidden:NO];
        [header.rightButton setImage:[UIImage imageNamed:@"btn_msg_a.png"] forState:UIControlStateNormal];
        [header.rightButton setImage:[UIImage imageNamed:@"btn_msg_b.png"] forState:UIControlStateHighlighted];
        [header setTipView];
        
        [header setClickRight];
        [[header leftButton] addTarget:dyViewController action:@selector(doLeft) forControlEvents:UIControlEventTouchUpInside];
        [[header rightButton] addTarget:dyViewController action:@selector(doRight) forControlEvents:UIControlEventTouchUpInside];
    }
}

//初始化addfriendbutton的图表,调整加好友按钮的显示
- (void)reloadAddFriend{
    if ([_userModel.isfriend isEqualToString:@"2"]) {//发过加好友的请求
        [self addFriendBt:2];
    }else if ([_userModel.isfriend isEqualToString:@"1"]){//已经是好友
        /*if([_userModel.canfriend isEqualToString:@"0"])
         {//只能加关注
         if ([_userModel.isfollow isEqualToString:@"0"]) {
         [self addFriendBt:1];
         }else{
         [self addFriendBt:5];
         }
         
         }else{
         [self addFriendBt:1];
         }*/
        [self addFriendBt:1];
    }else if ([_userModel.isfriend isEqualToString:@"3"]){//对方发过请求
        [self addFriendBt:3];
    }else{
        if ([_userModel.canfriend isEqualToString:@"1"]) {//不是好友
            [self addFriendBt:3];
        }
        else if([_userModel.canfriend isEqualToString:@"0"])
        {//只能加关注
            if ([_userModel.isfollow isEqualToString:@"1"]) {
                [self addFriendBt:5];
            }else{
                [self addFriendBt:4];
            }
        }
    }
}

//刷新主页
- (void)forGetUser:(NSString *)userId{
    NSMutableDictionary *params = [Rrequest_Data user_detail:userId];
    HttpHelp *help = [[HttpHelp alloc] initWithView:self showNotice:YES page:1];
    [help setconnectViewTag:1];
    [help startHttpEX_For_Tag:USERDETAIL :params isForTag:YES];
    [help setTag:@"2"];
}

- (void)reloadHeaderView{
    //给headerview上付值
    for (int i = 0; i < [numLabelArray count]; i++) {
        UILabel *numLabel = [numLabelArray objectAtIndex:i];
        if (numLabel.tag == 1) {
            [numLabel setText:_userModel.friend_num];
        }else if (numLabel.tag == 2){
            [numLabel setText:_userModel.visit_num];
        }else if (numLabel.tag == 3){
            [numLabel setText:_userModel.album_num];
        }else if (numLabel.tag == 4){
            [numLabel setText:_userModel.info_rate];
        }
    }
    [personLabel setText:_userModel.desc];
    [headPortrait setImageWithURL:[NSURL URLWithString:_userModel.pic_s] placeholderImage:[UIImage imageNamed:@"noface_64.png"]];
}


//添加好友的按钮的状态
- (void)addFriendBt:(NSInteger)type{
    if (type == 1) {//已经是好友
        [addMe setUserInteractionEnabled:YES];
        [addMe setTag:4];//删除好友
        [addMe addTarget:self action:@selector(footBarAction:) forControlEvents:UIControlEventTouchUpInside];
        [addMe setBackgroundImage:[UIImage imageNamed:@"btn_addfriend_d.png"] forState:UIControlStateNormal];
        [addMe setBackgroundImage:[UIImage imageNamed:@""] forState:UIControlStateHighlighted];
    }else if (type == 2){//发过加好友的请求
        [addMe setTag:200];
        [addMe setUserInteractionEnabled:NO];
        [addMe setBackgroundImage:[UIImage imageNamed:@"btn_addfriend_c.png"] forState:UIControlStateNormal];
        
    }else if (type == 3){//不是好友
        [addMe setUserInteractionEnabled:YES];
        [addMe setTag:1];
        [addMe setBackgroundImage:[UIImage imageNamed:@"btn_addfriend_a.png"] forState:UIControlStateNormal];
        [addMe addTarget:self action:@selector(footBarAction:) forControlEvents:UIControlEventTouchUpInside];
        [addMe setBackgroundImage:[UIImage imageNamed:@"btn_addfriend_b.png"] forState:UIControlStateHighlighted];
    }else if (type == 4){//只能加关注
        [addMe setUserInteractionEnabled:YES];
        [addMe setTag:5];
        [addMe setBackgroundImage:[UIImage imageNamed:@"btn_addnotice_a.png"] forState:UIControlStateNormal];
        [addMe addTarget:self action:@selector(footBarAction:) forControlEvents:UIControlEventTouchUpInside];
        [addMe setBackgroundImage:[UIImage imageNamed:@"btn_addnotice_b.png"] forState:UIControlStateHighlighted];
    }else if (type == 5){//已关注
        [addMe setTag:6];
        [addMe setBackgroundImage:[UIImage imageNamed:@"btn_addnotice_d.png"] forState:UIControlStateNormal];
        [addMe setBackgroundImage:[UIImage imageNamed:@""] forState:UIControlStateHighlighted];
        [addMe addTarget:self action:@selector(footBarAction:) forControlEvents:UIControlEventTouchUpInside];
        [addMe setUserInteractionEnabled:YES];
    }
}


//改背景
- (void)changeBg:(NSNotification *)obj{
    NSString *tag = [obj object];
    UserSettingMode *settingMode = [[YiBanLocalDataManager sharedInstance] currentUserSetting];
    [bgImg setImage:[UIImage imageNamed:settingMode.userPersonPageBg]];
    
    NSData *imgData = [CommonHelper zipImg:bgImg];
    [self sendBgForService:tag imgData:imgData];
}

//将背景图片上传到服务器上
- (void)sendBgForService:(NSString *)tag imgData:(NSData *)imgData{
    if (ifChangeBg) {
        NSMutableDictionary *params = [Rrequest_Data user_setbackground:@"0" tag:tag];
        [[[YiBanLocalDataManager sharedInstance] currentUser] setBackground_tag:tag];//更新当前用户的个人主页图片背景的tag
        HttpHelp *help = [[HttpHelp alloc] initWithView:self showNotice:YES page:1];
        [help startHttpEX:USERSETBACKGROUND :params data:imgData];
        [help setTag:USERSETBACKGROUND];
        ifChangeBg = NO;
    }
    
}

//通知中心（上传近照的接口）
- (void)useImg:(NSNotification *)obj{
    UIImage *object = [obj object];
    UIImageView *imgView = [[UIImageView alloc] initWithImage:object];
    
    if (ifChangeIcon) {
        YBLogInfo(@"icon");
        HttpHelp *help = [[HttpHelp alloc] initWithView:self showNotice:YES page:1];
        NSMutableDictionary  *params = [Rrequest_Data user_uploadavatar];
        NSData *data = [CommonHelper zipImg:imgView];
        [help startHttpEX:USERUPLOADAVATAR :params data:data];
        
    }
    //    [imgView release];
}

//主页的button事件
- (void)buttonAction:(id)sender{
    [[CommonHelper shareInstance]playSound:5];
    UIButton *bt = sender;
    
    YBLogInfo(@"bt.tag == %d", bt.tag);
    id viewController = nil;
    switch (bt.tag) {
            
        case 1://易友
            viewController = [[FriendsViewController alloc] init];
            //            [viewController setUser_id:_userModel.userid];
            //            [viewController setIsPush:YES];
            [viewController setParameter:_userModel.userid bPush:YES];
            break;
            
        case 2://访客
            
            viewController = [[PersonalPageComingViewController alloc] init];
            [viewController setComingUserModel:_userModel];
            [viewController setIsPush:isPush];
            
            break;
        case 3://相册
            viewController = [[PersonalPageImgViewController alloc] init];
            [viewController setIsOtherUser:isOtherPeople];
            [viewController setGetImgNameId:_userModel.userid];
            
            break;
        case 4://资料
            
            viewController = [[PersonalPageMessageViewController alloc] init:_userModel ifOtherPeople:isOtherPeople];
            
//            [DeBug addObserverObj:viewController toTargetObj:[[YiBanLocalDataManager sharedInstance] currentUser] forKeyPath:@"name" options:NSKeyValueObservingOptionNew|NSKeyValueObservingOptionOld context:viewController];            
            break;
        default:
            break;
            
    }
    //    [[[MainViewController share] navigationController] setNavigationBarHidden:YES animated:YES];
    [[[LLSplitViewController getmainController] navigationController] pushViewController:viewController animated:YES];
//    YBLogInfo(@"%d",[viewController retainCount]);

    ;
    [viewController release];
    
}

//显示修改签名
- (void)showSignal{
    [[signalView textView] setText:[self anaysisString]];
    [signalView setHidden:NO];
    [signalView showView];
    [headerWindows setTitleLabelString:@"修改心情"];
}

//alertView弹出框
- (void)alertView:(NSString *)content tag:(NSInteger)tag warning:(BOOL)wrning
{
    UITextView *lbWarning = [[UITextView alloc] initWithFrame:CGRectMake(10, 0, 210, 60)];
    [lbWarning setBackgroundColor:[UIColor clearColor]];
    [lbWarning setTextAlignment:UITextAlignmentLeft];
    [lbWarning setEditable:NO];
    [lbWarning setFont:YIREGISETVIEWCONTENT];
    [lbWarning setTextColor:YIREGISETCONTENTCLICKEDCOLOR];
    [lbWarning setText:content];
    
    YIBanAlertView *alertView = [[YIBanAlertView alloc] initWithFrame:CGRectMake(0, 0, 320, self.frame.size.height) middleView:lbWarning titleString:@"提示" bWarning:wrning];
    [alertView setDelegate:self];
    [alertView setTag:tag];
    //    [alertView setUserInteractionEnabled:YES];
    [self addSubview:alertView];
    [alertView release];
    [lbWarning  release];
    
}

//footbar上的方法(加好友|发私信|刷新)
- (void)footBarAction:(id)sender{
    [[CommonHelper shareInstance]playSound:5];
    UIButton *send = (UIButton *)sender;
    //    [send setUserInteractionEnabled:NO];
    if (send.tag == 1) {
        if ([_userModel.isfriend isEqualToString:@"3"]) {
            [self addFriend:@"1"];
        }else{
            [self addFriend:@""];
        }
        //        [self alertView:@"确认加好友？" tag:1 warning:NO];
    }else if (send.tag == 2){//发私信
        if ([[[YiBanLocalDataManager sharedInstance] currentUser].verify isEqualToString:@"0"]) {
            [theApp addWindowAlertView:NORESETALLTYPE type:2 warning:NO];
        }else{
            contact *con = [[contact alloc] init];
            con.user_info = _userModel;
            
            Msg_content_Controller *comingViewcontroller = [[Msg_content_Controller alloc] init:con];
            comingViewcontroller.isPush =YES;
            comingViewcontroller.isFromMain = YES;
            //        [[[MainViewController share] navigationController] setNavigationBarHidden:YES animated:YES];
            
            [[[LLSplitViewController getmainController] navigationController] pushViewController:comingViewcontroller animated:YES];
            
            [con release];
            [comingViewcontroller release];
        }
        
    }else if (send.tag == 3){//刷新
        
        [self forGetUser:_userId];
        /*
         NSString *opType = @"订阅消息";
         if ([userModel.rsstag isEqualToString:@"1"]) {
         opType = @"取消订阅";
         }
         
         UIActionSheet *action = [[UIActionSheet alloc] initWithTitle:opType delegate:self cancelButtonTitle:@"取消" destructiveButtonTitle:opType otherButtonTitles: nil];
         [action setTag:1];
         action.actionSheetStyle = UIActionSheetStyleBlackOpaque;
         [action showInView:self];*/
    }else if (send.tag == 4){
        //        [self deleteFriend];
        [self alertView:@"你确定要解除好友关系吗？" tag:2 warning:NO];
    }else if (send.tag == 5){
        [self addFriend:@""];
        //        [self alertView:@"加关注" tag:3 warning:NO];
    }else if (send.tag == 6){
        [self deleteFriend];
        //        [self alertView:@"你确认要取消关注吗？" tag:4 warning:NO];
    }
    
}

//修改主页背景
- (void)changePersonBg:(id)sender{
    ifChangeBg = YES;
    //    UITapGestureRecognizer *s = sender;
    /*
     PersonalPageBdImgViewController *controller = [[PersonalPageBdImgViewController alloc] init];
     [[[MainViewController share] navigationController]  pushViewController:controller animated:YES];
     [controller release];*/
    PersonalPageBgSelectViewController *c = [[PersonalPageBgSelectViewController alloc] init];
    //    [self.navigationController pushViewController:c animated:YES];
    [[[LLSplitViewController getmainController] navigationController]  pushViewController:c animated:YES];
    
    [c release];
}

//修改头像的sheet
- (void)changeMyIcon:(id)sender{
    UIActionSheet *sheet = [[UIActionSheet alloc] initWithTitle:@"修改头像" delegate:self cancelButtonTitle:@"取消" destructiveButtonTitle:nil otherButtonTitles:@"拍照", @"手机相册",@"查看头像", nil];
    [sheet setTag:2];
    //    [sheet setActionSheetStyle:UIActionSheetStyleBlackOpaque];
    [sheet showInView:self];
    [sheet release];
}

//弹出相机或者本地图片库0,相机 1,本地图片
- (void)callCameraOrPhotoLib:(NSInteger)phoneTag{
    if (phoneTag == 3) {//取消按钮的tag
        return;
    }
    
    if (phoneTag > 1) {
        BigImageViewController *bigImage = [[BigImageViewController alloc]init];
        bigImage.picURL = _userModel.pic_b;
        bigImage.delegate = self;
        [bigImage doNext];
        [[LLSplitViewController getmainController] presentModalViewController:bigImage animated:YES];
        [bigImage release];
        return;
    }
    UIImagePickerController *imgPicker = [[UIImagePickerController alloc] init];
    [imgPicker setDelegate:self];
    //    //是否允许编辑
    //    [imgPicker setAllowsImageEditing:NO];
    //设置是否取或者拍照
    if (phoneTag == 0) {
        [imgPicker setSourceType:UIImagePickerControllerSourceTypeCamera];
    }else if (phoneTag == 1){
        [imgPicker setSourceType:UIImagePickerControllerSourceTypePhotoLibrary];
    }
    [[LLSplitViewController getmainController] presentModalViewController:imgPicker animated:YES];
    [imgPicker release];
}

/**
 *设置个人签名接口user_setdesc
 */
- (void)changeSignal:(NSString *)text{
    NSMutableDictionary *params = [Rrequest_Data user_setdesc:text];
    HttpHelp *help = [[HttpHelp alloc] initWithView:self showNotice:YES page:1];
    [help startHttpEX_For_Tag:USERSETDESC :params isForTag:YES];
    [help setTag:@"4"];
}

//修改个性头像最后一步
- (void)changeOwnIcon:(NSString *)picId{
    NSMutableDictionary *params = [Rrequest_Data user_setavatar:picId];
    HttpHelp *help = [[HttpHelp alloc] initWithView:self showNotice:YES page:1];
    [help startHttpEX_For_Tag:USERSETAVATAR :params isForTag:YES];
    [help setTag:@"5"];
}

//订阅取消消息提醒
- (void)sendIfPush{
    NSString *op = @"1";
    if ([_userModel.rsstag isEqualToString:@"1"]) {
        op = @"0";
    }
    NSMutableDictionary *params = [Rrequest_Data user_rss:_userId op:op];
    HttpHelp *help = [[HttpHelp alloc] initWithView:self showNotice:YES page:1];
    [help startHttpEX_For_Tag:USERRSS :params isForTag:YES];
    [help setTag:@"3"];
    
}
//添加好友和接受被加为好友
- (void)addFriend:(NSString *)op{
    HttpHelp *help = [[HttpHelp alloc] initWithView:self showNotice:YES page:1];
    NSMutableDictionary *params = nil;
    //对方发过请求
    if ([_userModel.isfriend isEqualToString:@"3"]) {
        params = [Rrequest_Data message_applyfriend:_userId op:op];
        [help startHttpEX_For_Tag:MESSAGEAPPLYFRIEND :params isForTag:YES];
        [help setTag:@"6"];
    }else{//自己发添加好友请求
        params = [Rrequest_Data message_reqfriend:_userId];
        [help startHttpEX_For_Tag:user_message_reqfriend :params isForTag:YES];
        [help setTag:@"1"];
    }
    
}
//删除好友
- (void)deleteFriend{
    HttpHelp *help = [[HttpHelp alloc] initWithView:self showNotice:YES page:1];
    NSMutableDictionary *params = [Rrequest_Data user_delfriend:nil oneId:_userId];
    [help startHttpEX_For_Tag:USERDELFRIEND :params isForTag:YES];
    [help setTag:@"7"];
}

#pragma mark - yibanalertViewdelegate
- (void)YibanAlertViewCancelButton:(YIBanAlertView *)alertView
{
    [alertView removeFromSuperview];
    //    [send setUserInteractionEnabled:YES];
}
- (void)YibanAlertViewConfirmButton:(YIBanAlertView *)alertView
{
    if (alertView.tag == 1) {
        if ([_userModel.isfriend isEqualToString:@"3"]) {
            [self addFriend:@"1"];
        }else{
            [self addFriend:@""];
        }
        
    }else if (alertView.tag == 2){
        [self deleteFriend];
    }else if (alertView.tag == 3){
        [self addFriend:@""];
    }else if (alertView.tag == 4){
        [self deleteFriend];
    }
    [alertView removeFromSuperview];
    //    [send setUserInteractionEnabled:YES];
}

#pragma mark - Changesignalviewdelegate
- (void)cancelChangeSinaViewDelegate:(ChangeSignalView *)changeSignal button:(UIButton *)button{
    YBLogInfo(@"changeSignal.text === %@", changeSignal.textView.text);
    if (button.tag == 2) {
        NSString *text = [changeSignal.textView.text stringByTrimmingCharactersInSet:[NSCharacterSet whitespaceAndNewlineCharacterSet]];
        if (text.length > 0) {
            self.changePersonLabelString = text;
            analysisXiTongFace *analy = [[analysisXiTongFace alloc]init];
           NSString *temp = [analy outString:text];
//            [analy release];
            [self changeSignal:temp];
        }
    }
    [signalView setHidden:YES];
    [header setTitleLabelString:@"我的主页"];
}

#pragma mark - uiimagepicker
- (void)imagePickerController:(UIImagePickerController *)picker didFinishPickingMediaWithInfo:(NSDictionary *)info{
    
    [[LLSplitViewController getmainController] dismissModalViewControllerAnimated:NO];
    
    [NSTimer scheduledTimerWithTimeInterval:.5f target:self selector:@selector(timeForAction:) userInfo:[info objectForKey:@"UIImagePickerControllerOriginalImage"] repeats:NO];
    
    
}
- (void)imagePickerControllerDidCancel:(UIImagePickerController *)picker{
    [[LLSplitViewController getmainController] dismissModalViewControllerAnimated:YES];
}

//线程的方法
- (void)timeForAction:(id)sender{
    NSTimer *t = (NSTimer *)sender;
    UIImage *object = t.userInfo;
    
    UIImageView *imgView = [[UIImageView alloc] initWithImage:object];
    if (ifChangeIcon) {
        YBLogInfo(@"icon");
        HttpHelp *help = [[HttpHelp alloc] initWithView:self showNotice:YES page:1];
        NSMutableDictionary  *params = [Rrequest_Data user_uploadavatar];
        NSData *data = [CommonHelper zipImg:imgView];         
        [help startHttpEX:USERUPLOADAVATAR :params data:data];
        
    }
    /*PersonalPageImgSeeViewController *detail = [[PersonalPageImgSeeViewController alloc] init];
     NSMutableArray *imgArray = [[NSMutableArray alloc] initWithObjects:t.userInfo, nil];
     [detail setGetInObjectl:t.userInfo];
     [detail setImgArray:imgArray];
     [detail setAlbumId:nil];
     [detail setIfHaveImg:NO];
     [detail setIfReadOne:YES];
     [detail setUserId:_userId];
     
     [[LLSplitViewController getmainController] presentModalViewController:detail animated:YES];
     [detail release];*/
}


#pragma mark - alertviewdelegate
- (void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex{
    YBLogInfo(@"buttonIndex222 === %d",buttonIndex);
    
}

#pragma mark - actionsheetdelegate
- (void)actionSheet:(UIActionSheet *)actionSheet clickedButtonAtIndex:(NSInteger)buttonIndex{
    YBLogInfo(@"buttonIndex === %d", buttonIndex);
    if (actionSheet.tag == 1) {//修改订阅消息  sheet
        if (buttonIndex == 0) {
            [self sendIfPush];
        }
    }else if (actionSheet.tag == 2){//修改  头像
        ifChangeIcon = YES;
        ifChangeBg = NO;
        [self callCameraOrPhotoLib:buttonIndex];
    }
    
}

- (void)requestFail:(NSDictionary *)data message:(NSString *)message http:(HttpHelp *)help{
    [Static alertView:self msg:message];
    [[CommonHelper shareInstance] playSound:5];
    if ([help.tag isEqualToString:@"4"] || [help.tag isEqualToString:USERSETBACKGROUND]) { //修改心情|背景图
        return;
    }
    if (isPush)
        [self performSelector:@selector(back) withObject:nil afterDelay:1];
    else
        [[LLSplitViewController getmainController] showLeftView:YES];
}

#pragma mark -
#pragma mark - httpDelegate
#pragma mark -
- (void)requestSuccess:(NSDictionary *)data message:(NSString *)message http:(HttpHelp *)http
{
    if (message) {
        if (ifChangeIcon) {
            YBLogInfo(@"[dataDict objectForKey:@] === %@",[data objectForKey:@"pic_s"]);
            NSString *urlString = [[data objectForKey:@"id"] description];
            [self changeOwnIcon:urlString];
            ifChangeIcon=NO;
        }
    }else{
        [Static alertView:self msg:@"修改头像失败"];
    }
    [http release];
}

-(void)Http_resultFor_tag:(NSDictionary *)data :(NSString *)message :(HttpHelp *)help{
    YBLogInfo(@"data === %@", data);
    if ([help.tag isEqualToString:@"3"]) {
        YBLogInfo(@"订阅");
    }else if ([help.tag isEqualToString:@"1"]){//加好友请求成功
        if ([[data objectForKey:@"req"] isEqualToString:@"1"]) {
            if([_userModel.canfriend isEqualToString:@"0"])
            {//只能加关注
                [Static alertView:self msg:@"添加关注成功"];
                //                [self alertView:@"添加关注成功" tag:3 warning:YES];
                [self addFriendBt:5];
            }else{
                if ([_userModel.isfriend isEqualToString:@"3"]) {
                    [Static alertView:self msg:@"添加好友成功"];
                    //                    [self alertView:@"添加好友成功" tag:4 warning:YES];
                    [self addFriendBt:1];
                }else if ([_userModel.isfriend isEqualToString:@"0"]){
                    [Static alertView:self msg:@"好友申请已发送"];
                    //                    [self alertView:@"好友申请已发送" tag:4 warning:YES];
                    [self addFriendBt:2];
                }
            }
            
        }else{
            [Static alertView:self msg:@"添加好友失败"];
            //            [self alertView:@"添加好友失败" tag:3 warning:YES];
        }
        
        YBLogInfo(@"加好友");
    }else if ([help.tag isEqualToString:@"2"]){//获得用户信息
        
        
        NSString *strAccess = [data objectForKey:@"access"];
        
        if ([strAccess isEqualToString:@"1"]) {
            NSArray *arrData = [data objectForKey:@"user"];
            
            if ([arrData count] > 0) {
                //                user *u = [[user alloc]initWithDictionary:[data objectForKey:@"user"]];
                user *u = (user *)[[data objectForKey:@"user"] initDictionaryTo:[user class]];
                self.userModel = u;
                [self initViewDidLoad];
                //                [dyViewController setCheckPageView:YES];
                //                [dyViewController setUserModel:u];
                ////                [[dyViewController table_view] reloadData];
                //                [dyViewController refresh];
                [u release];
                [self reloadAddFriend];
                [self reloadHeaderView];
            }
        }
        else{
            CannotAccessViewController *noAccess = [[CannotAccessViewController alloc] init];
            
//            [noAccess setStrTaName:@"Ta的主页"];
            [self addSubview:noAccess.view];
            [noAccess release];
        }
        
        
    }else if ([help.tag isEqualToString:@"4"]){
        if ([[data objectForKey:@"desc"] isEqualToString:@"1"]) {
            [personLabel setText:changePersonLabelString];
            [[[YiBanLocalDataManager sharedInstance] currentUser] setDesc:changePersonLabelString];
            [_userModel setDesc:changePersonLabelString];
            //            [CommonHelper alertView:@"修改签名成功" tag:10 warning:YES view:self alertdelegate:self];
        }else{
            [Static alertView:self msg:@"修改心情失败"];
            //            [CommonHelper alertView:@"修改心情失败" tag:10 warning:YES view:self alertdelegate:self];
        }
        
        YBLogInfo(@"改个性签名");
    }else if ([help.tag isEqualToString:@"5"]){
        YBLogInfo(@"个人头像");
        NSString *urlString = [[data objectForKey:@"pic_s"] description];
        [_userModel setPic:urlString];
        [_userModel setPic_b:[data objectForKey:@"pic_b"]];
        [_userModel setPic_s:urlString];

        [[NSNotificationCenter defaultCenter]postNotificationName:@"changeUserImage" object:[data objectForKey:@"pic_s"]];//更换头像时把裁剪好的大小图片作为通知对象发出去
        [headPortrait setImageWithURL:[NSURL URLWithString:urlString]];
        //        [CommonHelper alertView:@"修改个人头像成功" tag:11 warning:YES view:self alertdelegate:self];
    }else if ([help.tag isEqualToString:@"6"]){//添加好友成功
        if ([[data objectForKey:@"apply"] isEqualToString:@"1"]) {
            [self addFriendBt:1];
            if ([_userModel.isfriend isEqualToString:@"3"]) {
                [_userModel setIsfriend:@"1"];
                [Static alertView:self msg:@"添加好友成功"];
                
                
                if([[RightViewController share].yb_new_request intValue] > 0)
                    [RightViewController share].yb_new_request = [NSString stringWithFormat:@"%i",[[RightViewController share].yb_new_request intValue]-1];
                [[RightViewController share] refreashHeadBarMessageCount];
                
                //                [self alertView:@"添加好友成功" tag:4 warning:YES];
            }else if ([_userModel.isfriend isEqualToString:@"0"]){
                [_userModel setIsfriend:@"2"];
                [Static alertView:self msg:@"好友申请已发送"];
                //                [self alertView:@"好友申请已发送" tag:4 warning:YES];
            }
            
        }else{
            [Static alertView:self msg:@"添加好友失败"];
            //            [self alertView:@"添加好友失败" tag:41 warning:YES];
        }
    }else if ([help.tag isEqualToString:@"7"]){//删除好友成功
        if ([[data objectForKey:@"result"] isEqualToString:@"1"]) {
            if ([_userModel.canfriend isEqualToString:@"1"]) {//不是好友
                [self addFriendBt:3];
                [Static alertView:self msg:@"成功解除好友关系"];
                [_userModel setIsfriend:@"0"];
                //                [self alertView:@"成功解除好友关系" tag:5 warning:YES];
            }
            else if([_userModel.canfriend isEqualToString:@"0"])
            {//只能加关注
                [self addFriendBt:4];
                [_userModel setIsfriend:@"0"];
                [Static alertView:self msg:@"取消关注成功"];
                //                [self alertView:@"取消关注成功" tag:6 warning:YES];
            }
            
            
        }else{
            [Static alertView:self msg:@"解除好友关系失败"];
            //            [self alertView:@"解除好友关系失败" tag:51 warning:YES];
        }
        
    }
    
    [help release];
}

//table的header
- (UIView *)tableHeaderView{
    UIView *tableHeader = [[UIView alloc] initWithFrame:CGRectMake(0, 0, 320, 230)] ;
    [tableHeader setBackgroundColor:[UIColor clearColor]];
    UITapGestureRecognizer *tapBgImg = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(changePersonBg:)];
    
    UserSettingMode *settingMode = [[YiBanLocalDataManager sharedInstance] currentUserSetting];
    
    NSString *bgImgViewName = settingMode.userPersonPageBg;
    if (isOtherPeople) {
        if (_userModel.background_tag && _userModel.background_tag.length > 0) {
            bgImgViewName = [NSString stringWithFormat:@"homebg_default%d.jpg",[_userModel.background_tag intValue]+1];
        }else{
            bgImgViewName = [NSString stringWithFormat:@"homebg_default1.jpg"];
        }
        
    }
    
    UIImageView *bgBImgview = [[UIImageView alloc] initWithFrame:CGRectMake(0, 250, 320, 250)];
    //    [bgBImgview setFrame:CGRectMake(0, 250, 320, 250)];
    [bgBImgview setImage:[UIImage imageNamed:@"nopull.png"]];
    [self addSubview:bgBImgview];
    [bgBImgview release];
    
    bgImg = [[UIImageView alloc] initWithImage:[UIImage imageNamed:bgImgViewName]];
    [bgImg setFrame:CGRectMake(0, BGIMGY, 320, 250)];
    
    
    [self addSubview:bgImg];
    [bgImg release];
    
    
    
    UIView *bgView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, 320, 150)];
    [tableHeader addSubview:bgView];
    [bgView release];
    if (isOtherPeople) {
        [bgView setUserInteractionEnabled:NO];
    }else{
        [bgView setUserInteractionEnabled:YES];
    }
    [bgView addGestureRecognizer:tapBgImg];
    [tapBgImg release];
    
    UIView *scrollView = [[UIView alloc] initWithFrame:CGRectMake(0, 150, 320, 400-150)];
    [scrollView setBackgroundColor:YIALLVIEWBGCOLOR];
    [tableHeader addSubview:scrollView];
    [scrollView release];
    
    //个人操作的背景
    UIView *tabView = [[UIView alloc] initWithFrame:CGRectMake(0, 115, 320, 35)];
    UIImageView *bgImgView = [[UIImageView alloc] initWithFrame:CGRectMake(0, 0, 320, 35)];
    [bgImgView setImage:[UIImage imageNamed:@"blackbar.png"]];
    [tabView addSubview:bgImgView];
    [bgImgView release];
    [tabView setBackgroundColor:[UIColor clearColor]];
    [tableHeader addSubview:tabView];
    [tabView release];
    
    //个人的操作
    UIButton *friendButton = [self tabButton:CGRectMake(100, 2, 55, 35) title:@"易友" num:_userModel.friend_num tag:1];
    [friendButton setTag:1];
    [friendButton addTarget:self action:@selector(buttonAction:) forControlEvents:UIControlEventTouchUpInside];
    [tabView addSubview:friendButton];
    [friendButton release];
    
    UIButton *comingBtton = [self tabButton:CGRectMake(100+55, friendButton.frame.origin.y, 55, 35) title:@"访客" num:_userModel.visit_num tag:2];
    [comingBtton setTag:2];
    [comingBtton addTarget:self action:@selector(buttonAction:) forControlEvents:UIControlEventTouchUpInside];
    [tabView addSubview:comingBtton];
    [comingBtton release];
    
    UIButton *imgListButton = [self tabButton:CGRectMake(100+55*2, friendButton.frame.origin.y, 55, 35) title:@"相册" num:_userModel.album_num tag:3];
    [imgListButton setTag:3];
    [imgListButton addTarget:self action:@selector(buttonAction:) forControlEvents:UIControlEventTouchUpInside];
    [tabView addSubview:imgListButton];
    [imgListButton release];
    
    UIButton *privateButton = [self tabButton:CGRectMake(100+55*3, friendButton.frame.origin.y, 55, 35) title:@"资料" num:_userModel.info_rate tag:4];
    [privateButton setTag:4];
    [privateButton addTarget:self action:@selector(buttonAction:) forControlEvents:UIControlEventTouchUpInside];
    [tabView addSubview:privateButton];
    [privateButton release];
    
    //头像图片背景图
    UIImageView *headPortraitbg = [[UIImageView alloc] initWithFrame:CGRectMake(7, 92, 78, 78)];
    [headPortraitbg setImage:[UIImage imageNamed:@"call_facebox.png"]];
    [tableHeader addSubview:headPortraitbg];
    [headPortraitbg release];
    
    UITapGestureRecognizer *tapClick = [[UITapGestureRecognizer alloc] init];
    if (!isOtherPeople) {
        [headPortraitbg setUserInteractionEnabled:YES];
        [tapClick addTarget:self action:@selector(changeMyIcon:)];
        [headPortraitbg addGestureRecognizer:tapClick];
        
    }else{
        
    }
    [tapClick release];

        //头像
    YBLogInfo(@"userModel.pic_b === %@", _userModel.pic_b);
    headPortrait = [[UIImageView alloc] initWithFrame:CGRectMake(7, 7, 64, 64)];
    [headPortrait setImageWithURL:[NSURL URLWithString:_userModel.pic_s] placeholderImage:[UIImage imageNamed:@"noface_64.png"]];
//    headPortrait.contentMode=UIViewContentModeScaleAspectFit;
    [headPortraitbg addSubview:headPortrait];
    [headPortrait release];
    
    UIImageView *headPortraittp = [[UIImageView alloc] initWithFrame:CGRectMake(7, 7, 64, 64)];
    [headPortraittp setImage:[UIImage imageNamed:@"call_faceshadow.png"]];
    [headPortraitbg addSubview:headPortraittp];
    [headPortraittp release];
    
    
    //个性签名的view
    UIView *personSign = [[UIView alloc] initWithFrame:CGRectMake(0, headPortraitbg.frame.origin.y+headPortraitbg.frame.size.height, 320, 25)];
    [tableHeader addSubview:personSign];
    [personSign release];
    
    
    UITapGestureRecognizer *tapSign = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(showSignal)];
    UITapGestureRecognizer *tapSign2 = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(showSignal)];
    
    UIImageView *signImg = [[UIImageView alloc] initWithFrame:CGRectMake(8, 5, 15, 15)];
    [signImg setUserInteractionEnabled:YES];
    [signImg setImage:[UIImage imageNamed:@"icon_pen.png"]];
    [personSign addSubview:signImg];
    if (isOtherPeople) {
        [signImg setHidden:YES];
    }
    
    
    personLabel = [[UILabel alloc] initWithFrame:CGRectMake(signImg.frame.size.width+signImg.frame.origin.x, 0, 320-(signImg.frame.size.width+signImg.frame.origin.x), 25)];

    
    
//    analysisXiTongFace *analysis = [analysisXiTongFace alloc]init;
    
    [personLabel setText:_userModel.desc];
    [personLabel setUserInteractionEnabled:YES];
    [personLabel setFont:YIPAGESIGNSIZE];
    [personLabel setBackgroundColor:[UIColor clearColor]];
    [personSign addSubview:personLabel];
    
    if (!isOtherPeople) {
        [signImg addGestureRecognizer:tapSign2];
        [personLabel addGestureRecognizer:tapSign];
    }
    
    [personLabel release];
    [tapSign release];
    [tapSign2 release];
    [signImg release];
    //lineImgView
    UIImageView *line = [[UIImageView alloc] initWithFrame:CGRectMake(0, personSign.frame.origin.y+personSign.frame.size.height, 320, 2)];
    [line setImage:[UIImage imageNamed:@"dotline1.png"]];
    [tableHeader addSubview:line];
    [line release];
    
    
    //我的动态按钮下的一条线
    UIImageView *movingLine = [[UIImageView alloc] initWithImage:[UIImage imageNamed:@"tabline.png"]];
    //    [movingLine setImage:[UIImage imageNamed:@"bb_line1.png"]];
    [tableHeader addSubview:movingLine];
    [movingLine release];
    //我的动态按钮
    UIButton *imgMyMoving = [[UIButton alloc] initWithFrame:CGRectMake(8, (tableHeader.frame.size.height+tableHeader.frame.origin.y)-32, 64, 32)];
    [movingLine setFrame:CGRectMake(0, (tableHeader.frame.size.height+tableHeader.frame.origin.y)-1 , 320, 1)];
    [imgMyMoving setImage:[UIImage imageNamed:@"tab_mypost_a.png"] forState:UIControlStateNormal];
    [tableHeader addSubview:imgMyMoving];
    [imgMyMoving release];
    
    if (isOtherPeople) {
        [imgMyMoving setImage:[UIImage imageNamed:@"tab_tapost_a.png"] forState:UIControlStateNormal];
    }
    
    return tableHeader;
}

//tab buttonview
- (UIButton *)tabButton:(CGRect)frame title:(NSString *)title num:(NSString *)num tag:(NSInteger)tag{
    //    [numLabelArray removeAllObjects];
    
    UIButton *friendButton = [[UIButton alloc] initWithFrame:frame];
    [friendButton setShowsTouchWhenHighlighted:YES];
    //    [friendButton setBackgroundImage:[UIImage imageNamed:@"btnlight.png"] forState:UIControlStateHighlighted];
    UILabel *friendTitle = [[UILabel alloc] initWithFrame:CGRectMake(0, 0, frame.size.width, 20)];
    [friendTitle setText:title];
    [friendTitle setAlpha:1.f];
    [friendTitle setFont:YIPAGEBARTOPSIZE];
    [friendTitle setTextAlignment:UITextAlignmentCenter];
    [friendTitle setTextColor:YIPAGETITLECOLOR];
    [friendTitle setBackgroundColor:[UIColor clearColor]];
    [friendButton addSubview:friendTitle];
    [friendTitle release];
    UILabel *friendNum = [[UILabel alloc] initWithFrame:CGRectMake(0, 16, frame.size.width, 15)];
    [friendNum setTextColor:[UIColor whiteColor]];
    [friendNum setText:num];
    [friendNum setTag:tag];
    [friendNum setAlpha:1.f];
    [friendNum setFont:YIPAGEBARDOWNSIZE];
    [friendNum setBackgroundColor:[UIColor clearColor]];
    [friendNum setTextColor:YIPAGETITLECOLOR];
    [friendNum setTextAlignment:UITextAlignmentCenter];
    [friendButton addSubview:friendNum];
    [numLabelArray addObject:friendNum];
    [friendNum release];
    return friendButton;
}


#pragma mark - scrollviewdelegate

//完成拖拽
- (void)scrollViewDidEndDragging:(UIScrollView *)scrollView willDecelerate:(BOOL)decelerate;
{
    [scrollView setScrollIndicatorInsets:UIEdgeInsetsMake(0, 0, 0, 0)];
}

- (void)scrollViewDidScroll:(UIScrollView *)scrollView{
    YBLogInfo(@"scrollViewDidScroll === %f", scrollView.contentOffset.y);
    float contentSetY = scrollView.contentOffset.y;
    
    [tableView setFrame:CGRectMake(0,downImgScroll.frame.origin.y+tableHeaderA.frame.size.height-scrollView.contentOffset.y, tableView.frame.size.width, tableView.frame.size.height)];
    if (contentSetY > BGIMGY) {
        contentSetY = scrollView.contentOffset.y;
    }else{
        contentSetY = BGIMGY;
    }
    
    [bgImg setFrame:CGRectMake(0, BGIMGY-contentSetY, bgImg.frame.size.width, bgImg.frame.size.height)];
    
    
}

#pragma mark - MessageDynamicViewControllerDelegate
- (void)tableViewScrollView:(UITableView *)_tableView scrollView:(UIScrollView *)_scrollView{
    YBLogInfo(@"scrollView.contentOffset.y === %f", _scrollView.contentOffset.y);
    float scrollY = _scrollView.contentOffset.y;
    float scrollY4 = _scrollView.contentOffset.y/4;
    
    if (scrollY > 0) {
        [downImgScroll setScrollEnabled:NO];
        if (-122-scrollY4 >= -215) {
            [downImgScroll setFrame:CGRectMake(downImgScroll.frame.origin.x, 44-scrollY4, downImgScroll.frame.size.width, downImgScroll.frame.size.height)];
            [tableView setFrame:CGRectMake(0, downImgScroll.frame.origin.y+tableHeaderA.frame.size.height, 320, tableView.frame.size.height)];
            [bgImg setFrame:CGRectMake(0, BGIMGY-scrollY4, bgImg.frame.size.width, bgImg.frame.size.height)];
            
        }else{
            [downImgScroll setFrame:CGRectMake(downImgScroll.frame.origin.x, -48, downImgScroll.frame.size.width, downImgScroll.frame.size.height)];
            [tableView setFrame:CGRectMake(0, downImgScroll.frame.origin.y+tableHeaderA.frame.size.height, 320, tableView.frame.size.height)];
            [bgImg setFrame:CGRectMake(0, -148, bgImg.frame.size.width, bgImg.frame.size.height)];
            
        }
        
    }else{
        [downImgScroll setScrollEnabled:YES];
        
    }
    
}


@end
